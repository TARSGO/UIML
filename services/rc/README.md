# 遥控器键鼠事件模块

---

## 模块介绍

1. 本模块实现了对机甲大师官方遥控器数据的解析和二次抽象封装，使用软总线机制，采用消息发布方式。目前本项目支持键盘鼠标的单击、长按、按下、抬起、按住五种事件，并支持`Ctrl`或`Shift`组合键触发，可以大幅简化对键盘数据的处理流程
2. **按键及鼠标左右键**
   - 一个按键事件包含**主键**、**事件类型**和**组合键**三个部分，当操作手的操作符合以上三项时，对应消息就会被发布
   - 主键：官方遥控器所支持的键盘按键以及鼠标左右键
   - 事件类型：有单击、长按、按下、抬起、按住五种
     - 单击：按键按下后在**长按判定时间**之前抬起，抬起时触发
     - 长按：按键按下超过**长按判定时间**，在超时时触发（而非抬起时）
     - 按下：在按键按下时触发
     - 抬起：在按键抬起时触发
     - 按住：在按键被按下时会连续定时触发，触发频率与`RC_UpdateKeys()`调用频率一致
   - 组合键：无组合键、`Ctrl`、`Shift`三种，注意主键选择`Ctrl`或`Shift`时组合键不可选择相同键。同时由于组合件仅在事件触发时判断`Ctrl`、`Shift`是否按下，因此需要先按下`Ctrl`或`Shift`再按下其他按键，否则很大可能会被识别为无组合件
3. **遥控器摇杆、拨杆、拨轮及鼠标移动**
    - 仅在数据有更新时向外发布对应部分的消息

---

## 模块依赖项

### 模块依赖

- 服务类模块
	- [串口模块](../bsp/README.md)（必选）
- 工具类模块
	- 无
### 文件依赖

- 本模块文件
	- `rc.c`（必选）
- 底层库文件 
	- `cmsis_os.h`（必选）

---

## 模块配置项

1. 模块配置项
    
    | 配置名 | 数值类型 | 默认值 | 说明 |
    | :---: | :---: | :---: | :---: |
    | `uart-x` | `uint8_t` | 0 | 遥控器对应串口号 |

### 配置示例：

```c
{"rc",CF_DICT{
    {"uart-x",IM_PTR(uint8_t, 3)},
    CF_DICT_END
}},
```

---

## 软总线接口

### 广播接口

> `key`类型有：`"W","S","A","D","S","C","Q","E","R","F","G","Z","X","C","V","B","left","right"`，其中`"left"`,`"right"`为鼠标左键与右键
> `combine-key`类型有：`"none","shift","ctrl"`

- **遥控器单击事件发生**：`/rc/key/on-click`

	- **广播类型**：普通方式（映射表数据帧）
    
    - **数据帧格式**

    | 数据字段名 | 数据类型 | 说明 |
    | :---: | :---: | :---: |
    | `key`         | `char*` | 哪个按键触发的该事件(实际解析时可以仅判断第一个字符) |
	| `combine-key` | `char*` | 触发该事件时的组合键类型 |

- **遥控器长按事件发生**：`/rc/key/on-long-press`

	- **广播类型**：普通方式（映射表数据帧）
    
    - **数据帧格式**

    | 数据字段名 | 数据类型 | 说明 |
    | :---: | :---: | :---: |
    | `key`         | `char*` | 哪个按键触发的该事件(实际解析时可以仅判断第一个字符) |
	| `combine-key` | `char*` | 触发该事件时的组合键类型 |

- **遥控器按下事件发生**：`/rc/key/on-down`

	- **广播类型**：普通方式（映射表数据帧）
    
    - **数据帧格式**

    | 数据字段名 | 数据类型 | 说明 |
    | :---: | :---: | :---: |
    | `key`         | `char*` | 哪个按键触发的该事件(实际解析时可以仅判断第一个字符) |
	| `combine-key` | `char*` | 触发该事件时的组合键类型 |

- **遥控器抬起事件发生**：`/rc/key/on-up`

	- **广播类型**：普通方式（映射表数据帧）
    
    - **数据帧格式**

    | 数据字段名 | 数据类型 | 说明 |
    | :---: | :---: | :---: |
    | `key`         | `char*` | 哪个按键触发的该事件(实际解析时可以仅判断第一个字符) |
	| `combine-key` | `char*` | 触发该事件时的组合键类型 |

- **遥控器按住事件发生**：`/rc/key/on-pressing`

	- **广播类型**：普通方式（映射表数据帧）
    
    - **数据帧格式**

    | 数据字段名 | 数据类型 | 说明 |
    | :---: | :---: | :---: |
    | `key`         | `char*` | 哪个按键触发的该事件(实际解析时可以仅判断第一个字符) |
	| `combine-key` | `char*` | 触发该事件时的组合键类型 |

> 以下的广播仅在数据有更新时向外发布对应部分的消息

- **广播右摇杆数据**：`/rc/right-stick`

	- **广播类型**：普通方式（映射表数据帧）
    
    - **数据帧格式**	

    | 数据字段名 | 数据类型 | 说明 |
    | :---: | :---: | :---: |
    | `x` | `int16_t` | x方向通道值(范围-660~660) |
	| `y` | `int16_t` | y方向通道值(范围-660~660) |

- **广播右摇杆数据**：`/rc/left-stick`

	- **广播类型**：普通方式（映射表数据帧）
    
    - **数据帧格式**

    | 数据字段名 | 数据类型 | 说明 |
    | :---: | :---: | :---: |
    | `x` | `int16_t` | x方向通道值(范围-660~660) |
	| `y` | `int16_t` | y方向通道值(范围-660~660) |

- **广播拨杆数据**：`/rc/switch`

	- **广播类型**：普通方式（映射表数据帧）
    
    - **数据帧格式**

        | 数据字段名 | 数据类型 | 说明 |
        | :---: | :---: | :---: |
        | `left`  | `uint8_t` | 左拨杆位置(上1/中3/下2)(每次广播仅有其中一个数据) |
		| `right` | `uint8_t` | 左拨杆位置(上1/中3/下2)(每次广播仅有其中一个数据) |

- **广播拨轮数据**：`/rc/wheel`

	- **广播类型**：普通方式（映射表数据帧）
    
    - **数据帧格式**

    | 数据字段名 | 数据类型 | 说明 |
    | :---: | :---: | :---: |
    | `value` | `int16_t` | 拨轮数据值(范围-660~660) |

- **广播鼠标移动数据**：`/rc/mouse-move`

	- **广播类型**：普通方式（映射表数据帧）
    
    - **数据帧格式**

    | 数据字段名 | 数据类型 | 说明 |
    | :---: | :---: | :---: |
    | `x` | `int16_t` | 鼠标x方向移动速度 |
	| `y` | `int16_t` | 鼠标y方向移动速度 |

### 远程函数接口

本模块暂无广播接口

---

## 注意事项

* `RC_InitKeyJudgeTime(rc,0x3ffff,50,500)`默认全部按键50~500ms之间为短按，大于500ms为长按，可自行修改
* 若要移植到非HAL库平台，需要将`RC_UpdateKeys()`中的`HAL_GetTick()`修改为目标平台中用于获取时间戳（既系统运行时间，单位ms）的API函数
