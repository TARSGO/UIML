# 软总线

---

## 简介

本项目是一个订阅发布管理模块，以实现多模块间解耦，模块之间可以通过订阅、发布话题进行数据交互

---

## 项目文件及依赖项

- 本项目文件
	- `softbus.c/h`
- 标准库文件
	- `stdint.h`、`string.h`、`stdlib.h`
- 其他项目文件
	- `vector.c/h`：[通用类型变长数组](../tools/universal_vector/README.md)

---

## 发布订阅模式简介

发布订阅模式是一种数据传输的模式，用于提供不同模块之间的数据传输通道

在这个模式中有两个角色，发送数据的一方称为**发布者**(Pulisher)，接收数据的一方称为**订阅者**(Subscriber)，发布者可以创建多个**话题**(Topic)并在该话题上发布消息，订阅者会关注自己感兴趣的话题，并获取在该话题上所发布的消息

![发布订阅模式](README-IMG/发布订阅模式.jpg)

如上图所示，每个发布者/订阅者就是一个模块，一个话题就是一个字符串，每个话题可以视作一个通信管道，发布者通过“发布”操作向管道中写入数据，关注该管道的订阅者就可以收到数据

相较于传统方式中模块间直接调用对方的函数来传递数据，该模式使用字符串话题来标记所传输数据的意义，使得模块间不产生函数依赖和类型依赖，从而不产生文件依赖（无需相互引用对方的文件），以此实现模块间的松耦合

---

## 本模块概念阐述

- **软总线**：是对本模块作用的一种形象描述，系统中的所有模块通过本模块所提供的“订阅/发布”功能进行数据传输，可以将本模块看做系统中的一根“总线”，各个模块挂接在总线上相互传输数据
	> 注：本软总线与CAN通信等协议有一定相似之处，Topic的作用就类似于CAN数据帧ID，可用于标记数据帧的发送者或作用，订阅者订阅数据就相当于设置过滤器，过滤出总线上所发布的广播数据中感兴趣的部分
- **数据帧**(Frame)：在总线上所传输的数据是以“数据帧”为单位的，每次发布就是向软总线上发送一个数据帧
	- 数据帧是一个结构体，包含【数据】和【元素个数】两个信息
	- 数据帧分为两种，映射表数据帧和列表数据帧
		- **映射表数据帧**：数据帧中所传输的是一个映射表，可读性较好，但解析过程较慢
		- **列表数据帧**：数据帧中所传输的是一个列表，可读性较弱，但解析速度很快
- **映射表**(Map)：由若干个“键-值”对构成，每个键是一个字符串，值为任意类型。每个键在表中只会出现一次，唯一对应着一个值，通过键即可找到所对应的值
	- 在本模块中一个“键-值”对被称为一个字段(Item)，其中包含对应的【键(key)】和【值(value)】两个信息
	- 键有时也称作【字段名】
- **列表**(List)：由有序的若干个值构成，每个值有一个索引，从0开始编号，通过索引即可获取对应的值
- **快速句柄**(FastHandle)：在[快速发布方式](#发布方式和选用原则)中，需要提前由话题字符串创建出快速句柄，后续发布时使用该句柄代替话题字符串，其作用与话题字符串一致
- **绑定数据**(bindData)：对于每一次订阅，订阅者可以绑定上一个自定义数据，在收到数据的同时也会收到该绑定数据
	> 例如：订阅者可以订阅一次topic1，此时绑定一个数据A，然后再次订阅topic1，并绑定一个数据B，那么当发布者在topic1上发布一次数据时，该订阅者可以收到两次数据，分别附带有所绑定的A和B

---

## 发布方式和选用原则

**发布方式**：本模块提供普通和快速两种发布方式
- 普通方式
	- 直接使用话题字符串发布，使用方便，可读性较好
	- 须使用映射表数据帧
	- 效率较低，适合发布频率较低的话题
- 快速方式
	- 须提前创建好快速句柄，用句柄发布，可读性较弱，使用较繁琐
	- 须使用列表数据帧
	- 效率较高，适合发布频率很高的话题

**性能表现**：在168MHz主频的STM32F407中，本模块有以下性能表现
- 普通发布方式在最简情况下最高能达到600kHz的调用频率，但随着注册的话题数和数据字段数量的增加，调用频率可能大幅下降至30kHz以下
- 快速发布方式能达到2MHz调用频率，且不随话题数和数据帧长度发生变化
	> 注：1. 最简情况指仅在单个话题上注册单个空回调函数；2. 若回调内逻辑增加，两种方式的发布频率都会明显下降

**选用原则**：基于可读性和效率的衡量，我们对发布方式的选用有以下建议
- 当话题的平均发布频率**小于1kHz**时，使用**普通**发布方式，一般用于上层模块间数据传输
- 当话题的平均发布频率**大于1kHz**时，使用**快速**发布方式，一般用于底层外设驱动模块

---

## 接口使用示例

> 注：此处仅展示基础用法，若要获取更多说明请查看项目文件中代码注释

**发布话题(发送数据)**

```c
/* 普通发布方式 */
uint8_t value1 = 0x01; //要发布的第一个值
float value2 = 1.0f; //要发布的第二个值
SoftBus_PublishMap("topic1", {
	{"key1", &value1},
	{"key2", &value2}
}); //向总线发布一个映射表数据帧

/* 快速发布方式 */
//创建快速句柄(只在程序初始化时创建一次)
SoftBusFastHandle handle = SoftBus_CreateFastHandle("topic2"); 
//发布数据帧
uint16_t value = 0x201; //要发布的第一个值
uint8_t array[2] = {0x20, 0x01}; //要发布的第二个值
SoftBus_FastPublish(handle, {&value, array}); //向总线发布一个列表数据帧
```

**订阅话题(接收数据)**
```c
//定义软总线回调函数，收到数据时会自动调用
void Callback(const char* topic, SoftBusFrame* frame, void* bindData)
{
	if(strcmp(topic, "topic1") == 0)
	{
		if(!SoftBus_CheckMapKeys(frame, {"key1", "key2"})) //确保数据帧中存在所需字段
			return;
		uint8_t value1 = *(uint8_t*)SoftBus_GetMapValue(frame, "key1"); //读取key1字段值
		float value2 = *(float*)SoftBus_GetMapValue(frame, "key2"); //读取key2字段值
		/* ...其他处理逻辑 */
	}
}

//为提高总线效率，一般使用单独回调函数订阅快速发布的话题
void FastCallback(const char* topic, SoftBusFrame* frame, void* bindData)
{
	uint16_t value = *(uint16_t*)SoftBus_GetListValue(frame, 0); //获取第一个值
	uint8_t* array = (uint8_t*)SoftBus_GetListValue(frame, 1); //获取第二个值
	/* ...其他处理逻辑 */
}

//订阅话题
SoftBus_Subscribe(NULL, Callback, "topic1");
SoftBus_Subscribe(NULL, Fastcallback, "topic2");
```

---

## 注意事项

1. 回调函数是在发布者所在线程中执行的，因此回调函数的执行速度应尽可能快，切不可发生阻塞
	> 注：用`SoftBus_Publish`或`SoftBus_FastPublish`函数发布时，只有当订阅了该topic的所有回调函数执行结束后，该发布函数才会退出
2. 软总线仅会传输数据的地址(data指针)，且数据指针仅保证在回调函数范围内有效，若需在回调函数外使用这些数据，请在回调中拷贝整个数据，而不只是保存数据指针
3. 在回调函数中不应对传入的数据帧进行修改，否则会影响同一topic下的其他回调
